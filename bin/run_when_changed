#!/bin/bash

set -e


if [ $# -eq 0 ]; then
  echo "Usage: $0 RUNFILE WATCH_FILE [WATCH_FILE_2 ...]"
  exit 1
fi

test_file=$1
shift 1

if [ ! -f $test_file ]; then
  echo "Could not find file to run: $test_file"
  exit 2
fi

RUN_PID=

# Watch all files and directories to know when to start running
inotifywait -mr --format '%w' -e modify $@ | while read file; do
  time=$(date +%H%M%S)
  #  echo "SIGNAL $time $file"
  if [[ -z "$RUN_PID" || -z "$(ps aux | grep $RUN_PID | grep $test_file)" ]]; then
    echo Starting $test_file.
    trap - INT TERM EXIT
    ./$test_file &
    RUN_PID=$!
    # Make sure to kill test process when this script is stopped.
    trap "kill -9 $RUN_PID" INT TERM EXIT
  fi
done
